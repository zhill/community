@startuml

title The sequence diagram for the proposed Harbor integration with Scanner Adapter
hide footbox
skinparam handwritten false

actor "User"
participant "Harbor UI"
participant "Harbor API"
participant "Scan Controller" as sc
participant "Job Service" as js
participant "Scan Job" as ScannerJob
participant "Scanner Adapter"
participant "Scanner"

database "Harbor Registry" as Registry
participant "Scanner Registry"
participant "Harbor Event Queue" as HarborEventQueue
participant "Event Handler" as EventHandler
participant "Scan Store" as ScanStore
database "Harbor DB"

User -> "Harbor UI" : (1) Scan(Artifact)
"Harbor UI" -> "Harbor API"
activate "Harbor API"
"Harbor API" -> sc : (2) Scan(Artifact)
activate sc
sc -> "Scanner Registry" : (3) GetDefault()
activate "Scanner Registry"
"Scanner Registry" -> "Harbor DB"
activate "Harbor DB"
"Harbor DB" --> "Scanner Registry"
deactivate "Harbor DB"
"Scanner Registry" --> sc : Registration
deactivate "Scanner Registry"
sc -> js : (4) ScheduleScanJob(Artifact, Registration)
activate js
js -> "ScannerJob" ** : Trigger
activate "ScannerJob"
js --> sc
deactivate js
sc --> "Harbor API"
deactivate sc
"Harbor API" --> "Harbor UI"
deactivate "Harbor API"

"ScannerJob" -> "ScannerJob" : (5) CreateScannerAdapterClient(RegistrationSettings)
"ScannerJob" -> "ScannerJob" : (6) CreateScanRequest(Artifact, Registration)

"ScannerJob" -> "Scanner Adapter" : (7) Scan(ScanRequest)
activate "Scanner Adapter"

"Scanner Adapter" -> "Scanner"
activate "Scanner"
"Scanner" -> "Registry" : (8) Pull(Artifact)
activate "Registry"
"Registry" --> "Scanner"
deactivate "Registry"
"Scanner" --> "Scanner Adapter"
deactivate "Scanner"
"Scanner Adapter" --> "ScannerJob"
deactivate "Scanner Adapter"

"ScannerJob" -> "Scanner Adapter" : (9) GetScanReport(ScanRequestID, ReportMIMEType)
activate "Scanner Adapter"
"Scanner Adapter" --> "ScannerJob"
deactivate "Scanner Adapter"

"ScannerJob" -> HarborEventQueue : (10) PublishScanCompletedEvent(Artifact, ScanReport, ReportMIMEType)
activate HarborEventQueue
HarborEventQueue --> "ScannerJob"
deactivate HarborEventQueue
js -> "ScannerJob" !!

HarborEventQueue -> EventHandler ** : (11) Handle(ScanCompleted)
activate EventHandler
EventHandler -> ScanStore : (12) SaveScanReport(Artifact, ScanReport, ReportMIMEType)
activate ScanStore
ScanStore -> "Harbor DB"
activate "Harbor DB"
"Harbor DB" --> ScanStore
deactivate "Harbor DB"
ScanStore --> EventHandler
deactivate ScanStore
HarborEventQueue -> EventHandler !!

|||

"User" -> "Harbor UI" : (13) GetScanReport(Artifact)
"Harbor UI" -> "Harbor API"
activate "Harbor API"
"Harbor API" -> ScanStore : (14) GetScanReport(Artifact, ReportMIMEType)
activate ScanStore
ScanStore -> "Harbor DB"
activate "Harbor DB"
"Harbor DB" --> ScanStore
deactivate "Harbor DB"
ScanStore --> "Harbor API" : ScanReport
deactivate ScanStore
"Harbor API" --> "Harbor UI"
"Harbor UI" --> User
deactivate "Harbor API"
@enduml
