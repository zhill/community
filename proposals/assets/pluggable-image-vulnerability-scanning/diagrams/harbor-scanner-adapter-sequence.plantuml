@startuml

title The sequence diagram for the proposed Harbor integration with Scanner Adapter
hide footbox
skinparam handwritten false

actor "User"
participant "Harbor UI"
participant "Harbor API"
participant "ScannerJob"
participant "Scanner Registry"
participant "Scanner Adapter"
participant "Scanner"

database "Registry"
database "Harbor DB"

User -> "Harbor UI" : (1) Scan(Digest)
"Harbor UI" -> "Harbor API"
activate "Harbor API"
"Harbor API" -> "ScannerJob" : (2) ScheduleScannerJob(Digest)
activate "ScannerJob"
"Harbor API" --> "Harbor UI" : Accepted
deactivate "Harbor API"

"ScannerJob" -> "Scanner Registry" : (3) GetDefault()
activate "Scanner Registry"
"Scanner Registry" --> "ScannerJob" : Registration
deactivate "Scanner Registry"

"ScannerJob" -> "ScannerJob" : (4) CreateScannerAdapterClient(RegistrationSettings)
"ScannerJob" -> "ScannerJob" : (5) PrepareScanRequest

"ScannerJob" -> "Scanner Adapter" : (6) SubmitScan(ScanRequest)
activate "Scanner Adapter"

"Scanner Adapter" -> "Scanner"
activate "Scanner"
"Scanner" -> "Registry" : (7) Pull(Digest)
activate "Registry"
"Registry" --> "Scanner"
deactivate "Registry"
"Scanner" --> "Scanner Adapter"
deactivate "Scanner"
"Scanner Adapter" --> "ScannerJob"
deactivate "Scanner Adapter"

"ScannerJob" -> "Scanner Adapter" : (8) GetScanReport(scanRequestID, reportMIMEType)
activate "Scanner Adapter"
"Scanner Adapter" --> "ScannerJob"
deactivate "Scanner Adapter"

"ScannerJob" -> "ScannerJob" : (9) CreateComponentsOverview(ScanReport)
"ScannerJob" -> "Harbor DB" : (10) Save(scanRequestID, reportMIMEType, ComponentsOverview)
activate "Harbor DB"
"Harbor DB" --> "ScannerJob"
deactivate "Harbor DB"
deactivate "ScannerJob"

|||

"User" -> "Harbor UI" : (11) GetScanReport(Digest)
"Harbor UI" -> "Harbor API"
activate "Harbor API"
"Harbor API" -> "Harbor DB" : (12) GetScanRequestId(Digest)
activate "Harbor DB"
"Harbor DB" --> "Harbor API" : scanRequestID
deactivate "Harbor DB"
"Harbor API" -> "Scanner Adapter" : (13) GetScanReport(ScanRequestID, ReportMIMEType)
activate "Scanner Adapter"
"Scanner Adapter" --> "Harbor API" : ScanReport
deactivate "Scanner Adapter"
"Harbor API" --> "Harbor UI" : HarborScanReport
deactivate "Harbor API"
@enduml
